name: LaTeX to Cloudflare
on: [push]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Compile All Reports
        uses: xu-cheng/latex-action@v3
        with:
          # This glob finds every main.tex in your project
          root_file: "**/main.tex"
          glob_root_file: true
          # CRITICAL: Changes PWD to the folder containing the current main.tex
          work_in_root_file_dir: true
          # Prevents one broken lab from stopping the entire build
          continue_on_error: true
          # Standard latexmk arguments
          args: "-pdf -file-line-error -halt-on-error -interaction=nonstopmode"

      - name: Organize for Deployment
        run: |
          mkdir -p deploy
          # Find all successfully compiled PDFs
          # Note: We rename 'main.pdf' to 'report.pdf' to avoid generic names in links
          find . -name "main.pdf" | while read -r pdf; do
            # Get the directory structure excluding '.'
            dir_path=$(dirname "$pdf" | sed 's|^\./||')
            mkdir -p "deploy/$dir_path"
            cp "$pdf" "deploy/$dir_path/report.pdf"
          done

      - name: Generate Index
        run: |
          # Robust Python script to generate a clean, browsable file list
          python3 -c "
          import os
          with open('deploy/index.html', 'w') as f:
              f.write('<html><head><title>Archive</title><style>body{font-family:sans-serif;padding:50px;line-height:1.5;} a{text-decoration:none;color:#0070f3;} li{margin-bottom:8px;}</style></head><body>')
              f.write('<h1>Lab Report Archive</h1><ul>')
              
              # Walk through the deploy folder to find our PDFs
              for